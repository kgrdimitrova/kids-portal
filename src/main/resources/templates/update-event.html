<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Update/View Event - Kids Portal</title>
    <link rel="stylesheet" href="/css/create-event-styles.css">
    <link rel="stylesheet" href="/css/global-styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One:wght@400&family=Open+Sans:wght@400;600;700&display=swap"
          rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
<!-- Header -->
<header class="portal-header">
    <div class="container">
        <div class="logo">
            <i class="fas fa-star"></i>
            <h1>Kids Portal</h1>
        </div>
        <nav class="top-nav">
            <a th:href="@{/home}" class="nav-btn">
                <i class="fas fa-home"></i>
                Home
            </a>
            <a class="nav-btn" th:href="@{'/events/' + ${event.id} + '/payments'}"
               th:if="${user != null and user.role != null and user.role.name() == 'TRAINER'}">
                <i class="fas fa-right-from-bracket"></i>
                View Payments
            </a>
            <a th:href="@{/logout}" class="nav-btn">
                <i class="fas fa-right-from-bracket"></i>
                Logout
            </a>
        </nav>
    </div>
</header>

<main class="portal-main">
    <div class="container">
        <!-- Page Header -->
        <section class="page-header">
            <h2><i class="fas fa-plus-circle"></i> Update/View Event</h2>
            <p>Fill out the form below to create an exciting new event for kids!</p>
        </section>

        <!-- Create Event Form -->
        <section class="create-event-section">
            <div class="form-container">
                <form class="event-form" id="createEventForm" th:action="@{'/events/' + ${event.id} + '/details'}"
                      th:method="PUT" th:object="${eventRequest}" enctype="multipart/form-data">
                    <!-- Basic Information -->
                    <div class="form-section">
                        <h3><i class="fas fa-info-circle"></i> Basic Information</h3>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="eventTitle">Event Title *</label>
                                <input type="text" id="eventTitle" name="title" placeholder="Enter event title" required
                                       th:field="*{title}" th:disabled="${user.id != event.creator.id}">
                                <p class="error-message" th:if="${#fields.hasErrors('title')}" th:errors="*{title}">
                                    Error Message</p>
                            </div>
                            <div class="form-group">
                                <label for="eventCategory">Category *</label>
                                <select id="eventCategory" name="category" required th:field="*{type}"
                                        th:disabled="${user.id != event.creator.id}">
                                    <option th:each="type : ${T(com.portal.kids.common.ActivityType).values}"
                                            th:value="${type}" th:text="${type}"></option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="eventDescription">Description *</label>
                            <textarea id="eventDescription" name="description" placeholder="Describe the event" rows="4"
                                      required th:field="*{description}"
                                      th:disabled="${user.id != event.creator.id}"></textarea>
                            <p class="error-message" th:if="${#fields.hasErrors('description')}"
                               th:errors="*{description}">Error Message</p>
                        </div>

                        <div class="form-group">
                            <label for="eventLocation">Location *</label>
                            <select id="eventLocation" name="location" required th:field="*{location}"
                                    th:disabled="${user.id != event.creator.id}">
                                <option th:each="location : ${T(com.portal.kids.common.Location).values}"
                                        th:value="${location}" th:text="${location}"></option>
                            </select>
                        </div>
                    </div>

                    <!-- Date & Time -->
                    <div class="form-section">
                        <h3><i class="fas fa-calendar-alt"></i> Date & Time</h3>

                        <div class="form-row compact-datetime">
                            <div class="form-group">
                                <label for="startDate">Start Date *</label>
                                <input type="date" id="startDate" name="startDate" required th:field="*{startDate}"
                                       th:disabled="${user.id != event.creator.id}">
                                <p class="error-message" th:if="${#fields.hasErrors('startDate')}"
                                   th:errors="*{startDate}">Error Message</p>
                            </div>
                            <div class="form-group">
                                <label for="startTime">Start Time</label>
                                <input type="time" id="startTime" name="startTime" required th:field="*{startTime}"
                                       th:disabled="${user.id != event.creator.id}">
                                <p class="error-message" th:if="${#fields.hasErrors('startTime')}"
                                   th:errors="*{startTime}">Error Message</p>
                            </div>
                            <div class="form-group">
                                <label for="endDate">End Date *</label>
                                <input type="date" id="endDate" name="endDate" required th:field="*{endDate}"
                                       th:disabled="${user.id != event.creator.id}">
                                <p class="error-message" th:if="${#fields.hasErrors('endDate')}" th:errors="*{endDate}">
                                    Error Message</p>
                            </div>
                            <div class="form-group">
                                <label for="endTime">End Time</label>
                                <input type="time" id="endTime" name="endTime" required th:field="*{endTime}"
                                       th:disabled="${user.id != event.creator.id}">
                                <p class="error-message" th:if="${#fields.hasErrors('endTime')}" th:errors="*{endTime}">
                                    Error Message</p>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="eventPeriodicity">Periodicity</label>
                            <select id="eventPeriodicity" name="periodicity" required th:field="*{periodicity}"
                                    th:disabled="${user.id != event.creator.id}">
                                <option th:each="periodicity : ${T(com.portal.kids.event.model.EventPeriodicity).values}"
                                        th:value="${periodicity}" th:text="${periodicity}"></option>
                            </select>
                        </div>
                    </div>

                    <!-- Additional Details -->
                    <div class="form-section">
                        <h3><i class="fas fa-cog"></i> Additional Details</h3>

                        <div class="form-group">
                            <label for="eventClub">Associated Club</label>
                            <select id="eventClub" name="club" th:field="*{clubId}"
                                    th:disabled="${user.id != event.creator.id}">
                                <option th:selected="${event.club == null}" value="" th:text="'-- Select a Club --'">--
                                    Select a Club --
                                </option>
                                <option th:each="club : ${clubs}" th:value="${club.id}" th:text="${club.name}"></option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="eventPicture">Picture</label>

                            <!-- Preview the current or fallback image -->
                            <img th:src="${#strings.isEmpty(event.imageUrl) ?
                  'https://tse4.mm.bing.net/th/id/OIP.RE3rCzXS4012lKexxIQfOAHaHa?w=644&h=644&rs=1&pid=ImgDetMain&o=7&rm=3'
                  : event.imageUrl}"
                                 alt="Event picture"
                                 style="max-width: 200px; border-radius: 8px; display: block; margin-bottom: 8px;">

                            <!-- Allow manual update of the picture URL -->
                            <input type="text"
                                   id="eventPicture"
                                   name="picture"
                                   th:field="*{imageUrl}"
                                   placeholder="Paste image URL here"
                                   class="form-control"
                                   th:disabled="${user.id != event.creator.id}">

                            <small class="text-muted">Paste a direct image URL (e.g.,
                                https://example.com/image.png)</small>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="maxParticipants">Max Participants</label>
                                <input th:field="*{maxParticipants}" type="number" id="maxParticipants"
                                       name="maxParticipants" placeholder="e.g., 20" min=0
                                       th:disabled="${user.id != event.creator.id}">
                            </div>
                            <div class="form-group">
                                <label for="ageRange">Age Range</label>
                                <select id="ageRange" name="ageRange" th:field="*{ageCategory}"
                                        th:disabled="${user.id != event.creator.id}">
                                    <option th:each="ageCategory : ${T(com.portal.kids.event.model.AgeCategory).values}"
                                            th:value="${ageCategory}" th:text="${ageCategory}"></option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="eventPayment">Payment Amount</label>
                            <input id="eventPayment" min="0" name="paymentAmount" placeholder="e.g., 50.00"
                                   step="0.01" th:field="*{pass}" type="number">
                            <small class="text-muted">Enter the payment amount for this event (leave empty if
                                free)</small>
                        </div>

                        <div class="form-group">
                            <label for="requirements">Requirements</label>
                            <textarea th:field="*{requirements}" id="requirements" name="requirements"
                                      placeholder="What should participants bring? Any special requirements?" rows="3"
                                      th:disabled="${user.id != event.creator.id}"></textarea>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button th:if="${user.id == event.creator.id}" type="submit" class="btn btn-success">
                            <i class="fas fa-check"></i>
                            Update Event
                        </button>
                    </div>
                </form>
            </div>
        </section>
    </div>
</main>

<!-- Footer -->
<th:block th:insert="fragments/footer :: footer"></th:block>

<script>
    // Form validation and handling
    //document.getElementById('createEventForm').addEventListener('submit', function(e) {
    //    e.preventDefault();
    //   handleFormSubmit();
    //});

    // Date validation
    document.getElementById('startDate').addEventListener('change', function () {
        const startDate = new Date(this.value);
        const endDateInput = document.getElementById('endDate');

        if (this.value && endDateInput.value) {
            const endDate = new Date(endDateInput.value);
            if (endDate < startDate) {
                showNotification('End date cannot be before start date', 'error');
                endDateInput.value = this.value;
            }
        }

        // Set minimum date for end date
        endDateInput.min = this.value;
    });

    // File upload preview
    document.getElementById('eventPicture').addEventListener('change', function (e) {
        const file = e.target.files[0];
        const preview = document.getElementById('filePreview');

        if (file) {
            if (file.size > 5 * 1024 * 1024) { // 5MB limit
                showNotification('File size must be less than 5MB', 'error');
                this.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                preview.innerHTML = `
                        <div class="image-preview">
                            <img src="${e.target.result}" alt="Preview">
                            <button type="button" class="remove-image" onclick="removeImage()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `;
            };
            reader.readAsDataURL(file);
        }
    });

    // Form functions
    //function handleFormSubmit() {
    //    const formData = new FormData(document.getElementById('createEventForm'));
    //    const eventData = Object.fromEntries(formData.entries());
    //
    //    // Add file if selected
    //    const pictureFile = document.getElementById('eventPicture').files[0];
    //    if (pictureFile) {
    //        eventData.picture = pictureFile.name;
    //    }
    //
    //    console.log('Event Data:', eventData);
    //    showNotification('Event created successfully!', 'success');
    //
    //   // Simulate form submission
    //    setTimeout(() => {
    //        window.location.href = '';
    //    }, 2000);
    //}

    function saveAsDraft() {
        const formData = new FormData(document.getElementById('createEventForm'));
        const eventData = Object.fromEntries(formData.entries());

        console.log('Draft Saved:', eventData);
        showNotification('Event saved as draft', 'info');
    }

    function resetForm() {
        if (confirm('Are you sure you want to reset the form? All data will be lost.')) {
            document.getElementById('createEventForm').reset();
            document.getElementById('filePreview').innerHTML = '';
            showNotification('Form reset successfully', 'info');
        }
    }

    function removeImage() {
        document.getElementById('eventPicture').value = '';
        document.getElementById('filePreview').innerHTML = '';
    }

    // Notification system
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;

        document.body.appendChild(notification);

        setTimeout(() => {
            notification.classList.add('show');
        }, 100);

        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => {
                if (document.body.contains(notification)) {
                    document.body.removeChild(notification);
                }
            }, 300);
        }, 3000);
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', function () {
        // Set minimum date to today
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('startDate').min = today;
        document.getElementById('endDate').min = today;

        // Animate form sections
        const sections = document.querySelectorAll('.form-section');
        sections.forEach((section, index) => {
            setTimeout(() => {
                section.style.opacity = '1';
                section.style.transform = 'translateY(0)';
            }, index * 200);
        });
    });
</script>
</body>
</html>
